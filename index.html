<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Impresion de Etiquetas v1.2</title>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        :root{
            --green:#008000;
            --green-bright:#00b300;
            --bg:#f4f4f4;
            --text:#000;
            --footer-bg:#222; /* Color para el footer */
        }
        /* Estilos base y de layout */
        html,body{height:100%; margin:0; background:var(--bg); font-family: "Segoe UI", Tahoma, sans-serif; color:var(--text); display:flex; flex-direction:column; min-height: 100vh;}
        .header-logo{position: absolute; top: 16px; right: 24px; height: 40px;} /* Estilo para el logo */
        .container{max-width:1100px; margin:24px auto; padding:16px; display:flex; gap:20px; align-items:flex-start; flex-grow: 1;} /* El contenedor principal crece */
        
        /* Footer Styles */
        footer {
            background: var(--footer-bg);
            color: white;
            padding: 10px 0;
            text-align: center;
            font-size: 12px;
            margin-top: auto; /* Empuja el footer hacia abajo */
        }

        /* Estilos del formulario */
        .form {
            width:360px;
            border:2px solid var(--green);
            border-radius:10px;
            padding:18px;
            box-shadow:0 6px 16px rgba(0,0,0,0.08);
            background:#fff;
        }
        .form h2{color:var(--green); margin:6px 0 14px;}
        label{display:block; margin-top:10px; font-weight:600;}
        input[type="text"]{
            width:100%; padding:10px; margin-top:6px; border:2px solid var(--green); border-radius:6px; box-sizing:border-box;
        }
        .read-only-input{background:#eee; color:#444;}
        button{
            margin-top:14px; padding:10px 14px; border-radius:6px; border:none;
            background:var(--green); color:#fff; cursor:pointer; font-weight:700;
        }
        button.secondary{background:#444; margin-left:8px;}
        .preview-wrap{
            flex:1;
            display:flex;
            flex-direction:column;
            gap:12px;
            align-items:flex-start;
        }

        /* Estilos de la etiqueta */
        .label-preview {
            width:760px;
            height:220px;
            border-radius:8px;
            border:2px solid #ccc;
            padding:12px;
            box-sizing:border-box;
            background:#fff;
            display:flex; 
            flex-direction:column;
            justify-content:space-between;
            box-shadow:0 8px 20px rgba(0,0,0,0.06);
            font-family: Arial, sans-serif;
        }

        .bottom-data{ 
            display:flex;
            justify-content:space-between;
            align-items: flex-end; 
            font-size:30px; 
            font-weight:900;
            padding:0 10px;
            height: 40px;
        }

        .center-date{
            font-size: 16px;
            font-weight: 700;
            color: #333;
            align-self: flex-end;
            text-align: center; /* Asegura que el texto esté centrado si el span es ancho */
        }

        .barcode-area{
            flex-grow:1;
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            padding-top: 10px; 
        }
        .barcode-text{
            text-align:center;
            font-weight:700;
            margin-top:8px;
            font-size:24px; 
        }

        /* print-friendly small */
        @media print {
            body{background:#fff;}
            .container{box-shadow:none;}
            button, .form, .preview-wrap h3, .preview-wrap div:last-child, .header-logo, footer {display:none;}
            .label-preview{width:100mm; height:50mm; box-shadow:none; border:none;} 
            .bottom-data{font-size:12pt; font-weight:bold;}
            .barcode-text{font-size:10pt;}
            .center-date{font-size: 8pt; font-weight: normal;}
        }
    </style>
</head>
<body>
    <img src="nidec-logo.png" alt="Logo de la Compañía" class="header-logo" onerror="this.style.display='none'"> 

    <div class="container">
        <div class="form">
            <h2>Escaneo / Datos</h2>

            <label for="fullCodeInput">Escanea el Código:</label>
            <input id="fullCodeInput" type="text" placeholder="Escanea aquí el código de barras" maxlength="17">

            <label for="codeInput">Producto:</label>
            <input id="codeInput" type="text" class="read-only-input" readonly placeholder="Code">

            <label for="lotInput">Serie:</label>
            <input id="lotInput" type="text" class="read-only-input" readonly placeholder="Lote">
            
            <div style="margin-top:10px; display:flex; gap:8px;">
                <button id="previewBtn">Generar Etiqueta</button>
                <button id="printZplBtn" class="secondary">Imprimir en Zebra</button> 
                <button id="downloadZplBtn" class="secondary">Descargar ZPL</button>
            </div>

            <p style="font-size:12px; color:#666; margin-top:8px;">
                **Nota:** La impresión usa el software de **Zebra Browser Print**.
            </p>

            <hr style="margin-top:12px;">
            <h4>Bloque ZPL de Imagen (Opcional)</h4>
            <textarea id="zplLogoInput" rows="4" placeholder="Pegue aquí el bloque ZPL ^GF..."></textarea>
        </div>

        <div class="preview-wrap">
            <h3 style="margin:0 0 6px 0; color:var(--green);">Vista previa de etiqueta</h3>

            <div class="label-preview" id="labelPreview">
                <div style="height:20px;"></div> 

                <div class="barcode-area">
                    <svg id="pvBigBarcode" style="width:100%; height:120px;"></svg> 
                    <div id="pvBarcodeText" class="barcode-text"></div> 
                </div>
                
                <div class="bottom-data">
                    <span id="pvCode"></span>
                    <span id="pvCenterDate" class="center-date"></span> <span id="pvLot"></span>
                </div>
            </div>

            <div style="margin-top:8px; width:100%;">
                <h4 style="margin:6px 0;">ZPL generado</h4>
                <textarea id="zplOutput" style="width:100%; height:150px; font-family:monospace;"></textarea>
            </div>
        </div>
    </div>
    
    <footer>
        Sistema de Impresión de Etiquetas | Desarrollado por Alondra Romero y Jorge Barron. Nidec IT Mexico | Nidec Embraco
    </footer>

<script>
/* HELPER: Obtener fecha actual en formato DD/MM/AAAA */
function getTodayDateFormatted() {
    const today = new Date();
    const dd = String(today.getDate()).padStart(2, '0');
    const mm = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0
    const yyyy = today.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
}

/* ELEMENTOS */
const fullCodeInput = document.getElementById('fullCodeInput');
const codeInput = document.getElementById('codeInput');
const lotInput = document.getElementById('lotInput');
const previewBtn = document.getElementById('previewBtn');
const printZplBtn = document.getElementById('printZplBtn'); 
const downloadZplBtn = document.getElementById('downloadZplBtn');

/* LÓGICA DE SEPARACIÓN AUTOMÁTICA DE DATOS */
fullCodeInput.addEventListener('input', (e) => {
    const fullCode = e.target.value.trim();
    if (fullCode.length >= 9) {
        codeInput.value = fullCode.substring(0, 9);
    } else {
        codeInput.value = fullCode;
    }
    
    if (fullCode.length > 9) {
        lotInput.value = fullCode.substring(9, 17);
    } else {
        lotInput.value = '';
    }
});


/* FUNCIONES DE GENERACIÓN Y DESCARGA */
previewBtn.addEventListener('click', generatePreviewAndZPL);

downloadZplBtn.addEventListener('click', () => {
    const zpl = document.getElementById('zplOutput').value;
    if(!zpl) { alert('Genera la vista previa primero.'); return; }
    const blob = new Blob([zpl], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'etiqueta.zpl'; a.click();
    URL.revokeObjectURL(url);
});

function generatePreviewAndZPL(){
    const fullCode = fullCodeInput.value.trim();
    const code = codeInput.value.trim();
    const lot = lotInput.value.trim();
    const todayDate = getTodayDateFormatted();
    const zplLogoBlock = document.getElementById('zplLogoInput').value || '';
    
    // --- Lógica de la Vista Previa (Frontend) ---
    // 1. Update preview fields
    document.getElementById('pvCode').textContent = code || '';
    document.getElementById('pvLot').textContent = lot || '';

    document.getElementById('pvCenterDate').textContent = fullCode ? `Fecha de Reimpresion: ${todayDate}` : '';
    
    // 2. Generate Barcode Preview
    try {
        const barcodeText = fullCode || ' ';
        JsBarcode("#pvBigBarcode", barcodeText, { 
            format:"CODE128", 
            width:3, 
            height:100, 
            displayValue:false, 
            margin:0 
        });
        document.getElementById('pvBarcodeText').textContent = fullCode || '';
    } catch(e){
        console.error("Error generando JsBarcode:", e);
    }
    
    // Si no hay código, limpiar el SVG
    if (!fullCode) {
        document.getElementById('pvBigBarcode').innerHTML = '';
        document.getElementById('pvBarcodeText').textContent = 'Escanea un código para generar la etiqueta.';
        document.getElementById('pvCenterDate').textContent = ''; 
    }


    // (14.5 x 5.5)
    // --- 3. Build ZPL (Código de Impresión) ---
    const zplParts = [];
    zplParts.push('^XA');
    zplParts.push('^PW600');
    zplParts.push('^LL300'); 
    
    // Incluir opcional logo block
    if(zplLogoBlock){
        zplParts.push(zplLogoBlock);
        zplParts.push('^FO20,10^XGLOGO.GRF,1,1^FS'); 
    }
    
    // 1. Código de Barras Completo - Centro/Arriba
    if(fullCode){
        zplParts.push(`^FO200,130^BY3^BCN,120,Y,N,N^FD${escapeZPL(fullCode)}^FS`);
    }

    // 2. Código (9 dígitos) - Esquina inferior izquierda
    zplParts.push(`^FO115,290^A0N,40,40^FD${escapeZPL(code)}^FS`);

    // 3. Cambio: Fecha Actual con prefijo "Fecha de Reimpresion:" - Centro inferior
    // La fuente es pequeña (20x20 dots), el texto es largo, y la posición X=180 es más céntrica.
    const fechaTextoZPL = `Fecha de Reimpresion: ${todayDate}`;
    zplParts.push(`^FO350,305^A0N,20,20^FD${escapeZPL(fechaTextoZPL)}^FS`);

    // 4. Lote (8 dígitos) - Esquina inferior derecha
    zplParts.push(`^FO700,290^A0N,40,40^FD${escapeZPL(lot)}^FS`);
    
    zplParts.push('^XZ');

    const zpl = zplParts.join('\r\n');
    document.getElementById('zplOutput').value = zpl;
}

/* Escape helper for ZPL (simple) */
function escapeZPL(s){
    if(!s) return '';
    // Los caracteres ZPL son sensibles a ^ y ~
    return String(s).replace(/\^/g,'').replace(/~/g,'').replace(/\r?\n/g,' ');
}

/* --- Lógica de Impresión Zebra Browser Print --- */
printZplBtn.addEventListener('click', () => {
    generatePreviewAndZPL(); 
    const zpl = document.getElementById('zplOutput').value;
    
    if(!zpl || !fullCodeInput.value) { alert('Genera la vista previa con un código escaneado primero.'); return; }
    
    try {
        if(typeof BrowserPrint === 'undefined'){
            loadScript('./BrowserPrint-3.0.216.min.js')
                .then(() => attemptPrint(zpl))
                .catch(() => alert('Error: No se pudo cargar Zebra Browser Print.'));
        } else {
            attemptPrint(zpl);
        }
    } catch(e) {
        alert('Error de impresión: Revisa la consola y Browser Print service.');
        console.error(e);
    }
});

function attemptPrint(zpl) {
    if (typeof BrowserPrint === 'undefined') {
        alert('El servicio Zebra Browser Print no está disponible o no se pudo cargar.');
        return;
    }

    BrowserPrint.getDefaultDevice("printer", function(printer) {
        if (!printer) {
            alert('No se detectó impresora Zebra. Verifica el servicio Browser Print.');
            return;
        }
        printer.send(zpl, 
            function() { alert('Etiqueta enviada a la impresora Zebra.'); }, 
            function(err) { alert('Error enviando a Zebra: '+err); }
        );
    }, function(e) {
        alert('Error accediendo a Browser Print: ' + e);
        console.error('Browser Print Error:', e);
    });
}

// Función para cargar script
function loadScript(src){
  //mandas a llamar a esta funcion con el url del script como parametro?
    return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
    });
}
</script>
</body>
</html>


